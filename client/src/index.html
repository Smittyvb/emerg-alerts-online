<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlertReady viewer</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.css" rel="stylesheet" />
    <link href="/main.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.js"></script>
    <script src="/elm.js"></script>
    <script>
      // should probably be some compile time constant
      if (!navigator.onLine) alert("You are offline. This won't work right.")
      mapboxgl.accessToken = 'pk.eyJ1Ijoic21pdG9wIiwiYSI6ImNrN3Qxa2thcjBseWgzZXFyNHltYmZoY3kifQ.wkK2XWkuwMoxB8-gvAl6jA';
      function getLang() {
        return navigator.language.split("-")[0] + "-CA";
      }
      let connectionStatus = "Connecting";
      function updateConnectionStatus(n) {
        if (n !== connectionStatus) {
          app.ports.updateConnectionStatus.send(n);
          connectionStatus = n;
        }
      }
      class WorldMap extends HTMLElement {
        connectedCallback() {
          console.log("<world-map> created");
          let map = new mapboxgl.Map({
            container: this,
            style: "mapbox://styles/smitop/ck7t6xcly0l2i1irwrgja99sp",
            center: [-105.42, 61.69],
            zoom: 2.38,
            hash: true,
            locale: getLang(),
          });
          map.addControl(new mapboxgl.FullscreenControl());
          map.addControl(new mapboxgl.NavigationControl());
          this._sources = [];
          this._map = map;
        }
        setPolygons(alerts) {
          console.log("Updating map polygons");
          this._sources.forEach(source => {
            this._map.removeSource(source);
            this._map.removeLayer(source);
          });
          this._sources = [];
          alerts.forEach(([id, areas]) => {
            this._sources.push(id);
            this._map.addSource(id, {
              type: "geojson",
              data: {
                type: "Feature",
                geometry: {
                  type: "Polygon",
                  coordinates:
                    [].concat.apply([], areas.map(data => 
                      data.polygon.map(polygon =>
                         polygon.split(" ")
                          .map(x => x.split(","))
                          .map(([lat, long]) => [parseFloat(long), parseFloat(lat)])
                      )
                    ))
                }
              }
            });
            this._map.addLayer({
              id,
              type: "fill",
              source: id,
              layout: {},
              paint: {
                "fill-color": "#088",
                "fill-opacity": 0.3333333333
              }
            })
          });
        }
      }
      customElements.define("world-map", WorldMap);
      let knownAlerts = {};
      window.addEventListener("DOMContentLoaded", function () {
        let app = Elm.Main.init({
          flags: {
            language: getLang(),
            now: Date.now(),
          },
        });
        function setMapData(ele, status) {
          ele.setPolygons(status);
        }
        let pendingMapData = null;
        app.ports.updateMapPolygons.subscribe(status => {
          let mapEle = document.getElementsByTagName("world-map");
          if (mapEle[0]) {
            setMapData(mapEle[0], status);
          } else {
            pendingMapData = status;
          }
        });
        window.app = app;
        let stream = new EventSource("http://100.115.92.204:8080/api/canada/event-stream");
        stream.onmessage = function(e) {
          // due to a bug, sometimes we see [], filter it
          let alerts = JSON.parse(e.data).filter(x => x.length !== 0);
          console.log(alerts);
          // TODO: update the status of the alert to indicate it was received via another method
          app.ports.updateAlerts.send(alerts.filter(a => !knownAlerts[a.alert.id]));
          alerts.forEach(a => knownAlerts[a.alert.id] = true);
          updateConnectionStatus("Connected");
        };
        stream.onerror = function(e) {
          updateConnectionStatus("Disconnected");
        };
      });
    </script>
  </head>
  <body>
    <noscript style="font-size: 2rem;padding: 1rem;display: block;">
      Sorry, you need to enable JavaScript to view alerts. Maybe in the future I'll add some
      server-side rendering, but don't get your hopes up.
    </noscript>
  </body>
</html>