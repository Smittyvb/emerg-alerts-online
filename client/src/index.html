<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlertReady viewer</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.css" rel="stylesheet" />
    <link href="/main.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.js"></script>
    <script src="/elm.js"></script>
    <script>
      // should probably be some compile time constant
      mapboxgl.accessToken = 'pk.eyJ1Ijoic21pdG9wIiwiYSI6ImNrN3Qxa2thcjBseWgzZXFyNHltYmZoY3kifQ.wkK2XWkuwMoxB8-gvAl6jA';
      function getLang() {
        return navigator.language.split("-")[0] + "-CA";
      }
      let connectionStatus = "Connecting";
      function updateConnectionStatus(n) {
        if (n !== connectionStatus) {
          app.ports.updateConnectionStatus.send(n);
          connectionStatus = n;
        }
      }
      class WorldMap extends HTMLElement {
        connectedCallback() {
          console.log("<world-map> created");
          let map = new mapboxgl.Map({
            container: this,
            style: "mapbox://styles/smitop/ck7t6xcly0l2i1irwrgja99sp",
            center: [-68.13734351262877, 45.137451890638886],
            zoom: 5,
            hash: true,
            locale: getLang(),
          });
          map.addControl(new mapboxgl.FullscreenControl());
          map.addControl(new mapboxgl.NavigationControl());
        }
      }
      customElements.define("world-map", WorldMap);
      window.addEventListener("DOMContentLoaded", function () {
        let app = Elm.Main.init({
          flags: {
            language: getLang(),
            now: Date.now(),
          },
          node: document.getElementById("elm-container"),
        });
        app.ports.updateMapStatus.subscribe(status => {
          console.log("Status", status);
        });
        window.app = app;
        let stream = new EventSource("http://100.115.92.204:8080/api/canada/event-stream");
        stream.onmessage = function(e) {
          // due to a bug, sometimes we see [], filter it
          let alerts = JSON.parse(e.data).filter(x => x.length !== 0);
          console.log(alerts);
          // TODO: update the status of the alert to indicate it was received via another method
          app.ports.updateAlerts.send(alerts.filter(a => !knownAlerts[a.alert.id]));
          alerts.forEach(a => knownAlerts[a.alert.id] = true);
          updateConnectionStatus("Connected");
        };
        stream.onerror = function(e) {
          updateConnectionStatus("Disconnected");
        };
      });
    </script>
  </head>
  <body>
    <div id="elm-container"></div>
    <div id="alerts-map"></div>
  </body>
</html>